{{/* Table Shortcode for Hugo Blox Builder. */}}
{{/* Load a CSV table from page dir falling back back to remote URL */}}
{{/* Defaults to expecting a comma-separated CSV with a header row. */}}

{{/*
    Docs: https://docs.hugoblox.com/content/writing-markdown-latex/#csv-table

    Parameters
    ----------
    src :
        Path or url to the csv table. Path is relative to the folder where the shortcode is called.
    delimiter : default ","
        Field delimiter.
    header : default "true"
        If "true", the first row is rendered as the header.
    caption : optional
        Caption for the table.
*/}}

{{ $src := .Get "path" }}
{{ $delimiter := .Get "delimiter" | default "," }}
{{ $useHeaderRow := (eq (lower (.Get "header")) "true") | default true }}
{{ $caption := .Get "caption" }}

{{ $is_remote := strings.HasPrefix $src "http" }}
{{ if not $is_remote }}
  {{ $src = path.Join  "content" $.Page.File.Dir $src }}
{{ end }}
{{/* Replace deprecated getCSV with resources + transform.Unmarshal */}}
{{ $res := nil }}

{{ if (hasPrefix $src "http") }}
  {{ $res = resources.GetRemote $src }}
{{ else }}
  {{/* Try assets/ first (Hugo Pipes reads from /assets) */}}
  {{ $res = resources.Get $src }}
  {{ if not $res }}
    {{/* Try content bundle resources (same folder as the page) */}}
    {{ $res = .Page.Resources.GetMatch $src }}
  {{ end }}
  {{ if not $res }}
    {{/* Last fallback: assets/data/<src> */}}
    {{ $res = resources.Get (printf "data/%s" $src) }}
  {{ end }}
{{ end }}

{{ $rows := $res | transform.Unmarshal (dict "delimiter" $delimiter) }}

<table class="table">
  {{ if $useHeaderRow }}
    {{ $headerRow := index $rows 0 }}
    {{ $rows = after 1 $rows }}
    <tr> {{ range $headerRow }} <th>{{ . | markdownify | emojify }}</th> {{ end }} </tr>
  {{ end }}
  {{ range $rows }}
    <tr>
      {{ range . }}
        {{ if (findRE "^\\d+$" .) }}
          <td data-table-dtype="number">{{ . }}</td>
        {{ else }}
          <td data-table-dtype="text">{{ . | markdownify | emojify }}</td>
        {{ end }}
      {{ end }}
    </tr>
  {{ end }}
  {{ if $caption }}
    <caption>{{ $caption | markdownify | emojify }}</caption>
  {{ end }}
</table>
